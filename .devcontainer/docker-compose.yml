services:
 app:
   image: mcr.microsoft.com/devcontainers/javascript-node:20
   command: sleep infinity
   volumes:
     - ..:/workspaces/${localWorkspaceFolderBasename}:cached
   working_dir: /workspaces/${localWorkspaceFolderBasename}
   depends_on:
     mongo:
       condition: service_healthy
     redis:
       condition: service_healthy

 mongo:
   image: mongo:7
   restart: unless-stopped
   environment:
     MONGO_INITDB_ROOT_USERNAME: root
     MONGO_INITDB_ROOT_PASSWORD: example
   volumes:
     - mongo-data:/data/db
   healthcheck:
     test: ["CMD-SHELL", "echo 'db.runCommand({ping:1}).ok' | mongosh --host 127.0.0.1 --port 27017 --username root --password example --authenticationDatabase admin --quiet | grep -q 1"]
     interval: 5s
     timeout: 3s
     retries: 20

 redis:
   image: redis:7
   restart: unless-stopped
   command: ["redis-server", "--appendonly", "yes"]
   volumes:
     - redis-data:/data
   healthcheck:
     test: ["CMD", "redis-cli", "ping"]
     interval: 5s
     timeout: 3s
     retries: 20

volumes:
 mongo-data:
 redis-data:

